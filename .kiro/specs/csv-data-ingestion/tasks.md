<!--
╔══════════════════════════════════════════════════════════════════════════════╗
║  📚 KIRO 学習ガイド: CSV取り込み機能のタスク管理                             ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  このファイルは複雑な機能のタスク分解サンプルです。                          ║
║                                                                              ║
║  タスク構成の特徴:                                                           ║
║  - 機能別のグループ化（S3読み取り、CSV解析、DB統合 等）                      ║
║  - プロパティテストを独立タスクとして管理（[ ]* マーク）                     ║
║  - チェックポイントで品質を保証                                              ║
║                                                                              ║
║  [ ]* の意味:                                                                ║
║  - プロパティテスト専用のタスク                                              ║
║  - design.md の正確性プロパティに対応                                        ║
║  - 実装完了後に追加で実装するテスト                                          ║
║                                                                              ║
║  学習ポイント:                                                               ║
║  - 大きな機能を小さなタスクに分解する方法                                    ║
║  - テストタスクと実装タスクの関係                                            ║
║  - チェックポイントの活用                                                    ║
║                                                                              ║
║  詳細: KIRO_LEARNING.md の「4. Spec駆動開発」を参照                          ║
╚══════════════════════════════════════════════════════════════════════════════╝
-->

# 実装計画

- [x] 1. プロジェクト構造とコア機能の設定



  - `csv_ingest/`ディレクトリを作成
  - `csv_ingest/app.py`ファイルを作成
  - 基本的なLambda関数構造を実装
  - 必要なPythonライブラリ（boto3、csv、io、os）をインポート
  - _要件: 1.1, 1.2_

- [ ] 2. S3ファイル読み取り機能の実装
  - [x] 2.1 S3イベント処理ロジックを実装


    - Lambda関数でS3イベントからバケット名とオブジェクトキーを抽出
    - S3クライアントを初期化
    - _要件: 1.1, 1.2, 1.3_

  - [ ]* 2.2 プロパティテスト：CSVファイル読み取りの一貫性
    - **プロパティ 1: CSVファイル読み取りの一貫性**
    - **検証対象: 要件 1.3, 1.4**

  - [x] 2.3 S3オブジェクト読み取り機能を実装



    - `get_object`APIを使用してファイル内容を取得
    - UTF-8エンコーディングでファイル内容をデコード
    - ファイルアクセスエラーのハンドリング
    - _要件: 1.3, 1.4, 1.5_

- [ ] 3. CSV解析機能の実装
  - [x] 3.1 CSV解析ロジックを実装



    - `io.StringIO`を使用してCSV文字列を処理
    - `csv.reader`でヘッダーなしCSVを解析
    - 各行を5つのフィールドとして処理
    - _要件: 2.1, 2.2_

  - [ ]* 3.2 プロパティテスト：CSV行解析の正確性
    - **プロパティ 2: CSV行解析の正確性**
    - **検証対象: 要件 2.2, 2.4**

  - [x] 3.3 データ検証と変換機能を実装



    - フィールド数の検証（5フィールド未満の行をスキップ）
    - CityIdとRainfallProbabilityの整数変換
    - データ型変換エラーのハンドリング
    - _要件: 2.3, 2.4, 2.5_

- [ ] 4. DynamoDB統合機能の実装
  - [x] 4.1 DynamoDB接続とテーブル設定を実装



    - DynamoDBリソースを初期化
    - 環境変数からTABLE_NAMEを取得
    - テーブルオブジェクトを作成
    - _要件: 3.1, 5.2_

  - [ ]* 4.2 プロパティテスト：データ永続化の完全性
    - **プロパティ 3: データ永続化の完全性**
    - **検証対象: 要件 3.1, 3.2**

  - [ ]* 4.3 プロパティテスト：環境設定の動的取得
    - **プロパティ 7: 環境設定の動的取得**
    - **検証対象: 要件 5.2**

  - [x] 4.4 データ書き込み機能を実装



    - 有効なCSV行からDynamoDBアイテムを作成
    - `put_item`を使用してデータを保存
    - 書き込み成功時の処理済みカウント更新
    - データベース書き込みエラーのハンドリング
    - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 5. エラーハンドリングとログ機能の実装
  - [x] 5.1 包括的なログ機能を実装



    - 処理開始ログの記録
    - 無効な行とエラーの詳細ログ
    - 処理完了時の統計情報ログ
    - _要件: 4.1, 4.2, 4.3_

  - [ ]* 5.2 プロパティテスト：ログ記録の包括性
    - **プロパティ 6: ログ記録の包括性**
    - **検証対象: 要件 4.1, 4.2, 4.3**

  - [x] 5.3 エラー処理とレスポンス機能を実装



    - 重大なエラー時の例外発生
    - 正常終了時のHTTPレスポンス（ステータス200）
    - 処理結果を含むレスポンスボディ
    - _要件: 4.4, 4.5_

  - [ ]* 5.4 プロパティテスト：エラー処理の継続性
    - **プロパティ 5: エラー処理の継続性**
    - **検証対象: 要件 2.3, 2.5, 3.4**

- [ ] 6. 処理統計とレスポンス機能の実装
  - [x] 6.1 処理カウント機能を実装



    - 成功した処理レコード数のカウント
    - スキップされた行数のトラッキング
    - 最終的な処理統計の計算
    - _要件: 3.3, 3.5_

  - [ ]* 6.2 プロパティテスト：処理カウントの正確性
    - **プロパティ 4: 処理カウントの正確性**
    - **検証対象: 要件 3.3, 3.5**

  - [x] 6.3 レスポンス生成機能を実装



    - 処理済みレコード数を含む成功レスポンス
    - JSON形式でのレスポンスボディ作成
    - HTTPステータスコードの設定
    - _要件: 3.5, 4.5_

- [x] 7. チェックポイント - 全てのテストが通ることを確認



  - 全てのテストが通ることを確認し、問題があれば質問する

- [ ] 8. SAMテンプレート統合
  - [x] 8.1 SAMテンプレートにLambda関数を追加



    - 新しいLambda関数リソースを定義
    - 必要なIAM権限（S3読み取り、DynamoDB書き込み）を設定
    - 環境変数（TABLE_NAME）を設定
    - _要件: 5.1, 5.3, 5.4_

  - [x] 8.2 S3イベントトリガーを設定



    - S3バケットリソースを定義または更新
    - CSVファイルアップロード時のイベント通知を設定
    - Lambda関数への適切な権限を付与
    - _要件: 1.1, 1.2, 5.4_

- [ ]* 8.3 統合テスト
  - S3アップロードからDynamoDB書き込みまでのエンドツーエンドテスト
  - 実際のCSVファイルを使用したテスト
  - エラーケースの統合テスト
  - _要件: 全要件_

- [x] 9. 最終チェックポイント - 全てのテストが通ることを確認



  - 全てのテストが通ることを確認し、問題があれば質問する