<!--
╔══════════════════════════════════════════════════════════════════════════════╗
║  📚 KIRO 学習ガイド: design.md（設計書）                                     ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  このファイルは Spec駆動開発の第2ステップ「How（どう作るか）」を定義します。 ║
║                                                                              ║
║  構成要素:                                                                   ║
║  1. アーキテクチャ - 全体構成図（ASCII図推奨）                               ║
║  2. コンポーネントとインターフェース - 各コンポーネントの責任範囲            ║
║  3. データモデル - DBスキーマ、JSONフォーマット                              ║
║  4. 正確性プロパティ - テストで検証すべき性質                                ║
║  5. エラーハンドリング - エラー分類と対応                                    ║
║  6. テスト戦略 - 単体/統合/プロパティベーステスト                            ║
║                                                                              ║
║  正確性プロパティとは:                                                       ║
║  - 「すべての〜において、〜が成り立つ」形式で記述                            ║
║  - テストコードで直接検証可能な性質                                          ║
║  - 例: 「すべての認証済みリクエストでデータが返却される」                    ║
║                                                                              ║
║  詳細: KIRO_LEARNING.md の「4. Spec駆動開発」を参照                          ║
╚══════════════════════════════════════════════════════════════════════════════╝
-->

# 設計文書

## 概要

サーバーレス会員制天気ニュースシステムは、AWS のサーバーレスサービスを活用して構築される認証機能付きの天気情報表示システムです。システムは自動的にランダムな天気データを生成し、認証されたユーザーに対して日本語のインターフェースで天気情報を提供します。

## アーキテクチャ

### 全体アーキテクチャ

```
[React Frontend (S3)] 
    ↓ HTTPS
[CloudFront Distribution]
    ↓ API calls
[API Gateway]
    ↓ invoke
[Lambda Functions]
    ↓ read/write
[DynamoDB]

[Cognito User Pool] ← 認証
```

### サーバーレスアーキテクチャの利点

- **自動スケーリング**: トラフィックに応じた自動的な処理能力調整
- **従量課金**: 使用した分のみの課金
- **運用負荷軽減**: サーバー管理不要
- **高可用性**: AWSの管理されたサービスによる信頼性

## コンポーネントとインターフェース

### 1. フロントエンド（React）

**責任範囲:**
- ユーザーインターフェースの提供
- 認証状態の管理
- API呼び出しとデータ表示

**主要コンポーネント:**
- `AuthComponent`: ログイン/ログアウト機能
- `WeatherDisplay`: 天気情報表示
- `App`: メインアプリケーション

### 2. API Gateway

**責任範囲:**
- RESTful APIエンドポイントの提供
- CORS設定
- 認証の検証

**エンドポイント:**
- `GET /weather`: 現在の天気データ取得
- `POST /weather/generate`: 新しい天気データ生成
- `GET /health`: ヘルスチェック

### 3. Lambda Functions

#### WeatherService Lambda
**責任範囲:**
- 天気データの生成
- DynamoDBとのデータ操作
- ビジネスロジックの実行

**主要関数:**
- `get_current_weather()`: 最新天気データ取得
- `generate_weather_data()`: ランダム天気データ生成
- `save_weather_data()`: データ永続化

#### AuthService Lambda
**責任範囲:**
- 認証トークンの検証
- ユーザー情報の取得

### 4. DynamoDB

**責任範囲:**
- 天気データの永続化
- 高速なデータアクセス

### 5. Cognito User Pool

**責任範囲:**
- ユーザー認証
- JWTトークン発行
- セッション管理

## データモデル

### WeatherData テーブル (DynamoDB)

```json
{
  "CityId": "number (1=札幌, 13=東京, 23=名古屋, 27=大阪, 40=博多)",
  "CityName": "string (札幌|東京|名古屋|大阪|博多)",
  "WeatherName": "string (晴れ|くもり|雨)",
  "RainfallProbability": "number (0-100)",
  "timestamp": "string (ISO 8601)",
  "created_at": "string (ISO 8601)",
  "ttl": "number (Unix timestamp)"
}
```

**インデックス:**
- Primary Key: `CityId`
- GSI: `timestamp-index` (最新データの効率的な取得)
- LSI: `CityId-timestamp-index` (都市別の時系列データ取得)

### User データ (Cognito管理)

```json
{
  "sub": "string (UUID)",
  "email": "string",
  "email_verified": "boolean",
  "cognito:username": "string"
}
```

## 正確性プロパティ

*プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。これは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなる正式な記述です。*

### プロパティ反映

事前作業分析の結果、以下の正確性プロパティを特定しました：

**プロパティ 1: 認証制御**
*すべての*システムアクセスにおいて、未認証ユーザーは認証を要求され、認証済みユーザーのみが天気データにアクセスできる
**検証対象: 要件 1.1, 1.4**

**プロパティ 2: 全都市データ取得**
*すべての*天気データ要求において、システムは5つの主要都市（札幌、東京、名古屋、大阪、博多）すべてのデータを同時に返す
**検証対象: 要件 1.2, 2.4**

**プロパティ 3: 都市データ識別**
*すべての*複数都市天気データにおいて、各都市名と対応する天気情報が明確に区別されて表示される
**検証対象: 要件 1.5**

**プロパティ 4: 日本語天気タイプ表示**
*すべての*天気データ表示において、天気タイプは日本語（晴れ、くもり、雨）のみを使用する
**検証対象: 要件 1.3, 4.2**

**プロパティ 5: 全都市データ生成**
*すべての*データ生成実行において、システムは5つの主要都市すべてのランダムな天気データを生成する
**検証対象: 要件 2.1**

**プロパティ 6: データ永続化完全性**
*すべての*生成された天気データは、都市ID、都市名、タイムスタンプ、天気タイプ、降水確率を含んでデータストアに永続化される
**検証対象: 要件 2.2, 2.3**

**プロパティ 7: 障害分離処理**
*すべての*複数都市データ処理において、一つの都市のデータ処理失敗が他の都市の処理に影響しない
**検証対象: 要件 2.6**

**プロパティ 8: エラー処理**
*すべての*システムエラーにおいて、詳細なエラーログが記録され、適切なエラーレスポンスが返される
**検証対象: 要件 2.5, 5.1**

**プロパティ 9: 複数都市UI表示**
*すべての*複数都市天気データ表示において、各都市の情報が整理された形式で同時に表示される
**検証対象: 要件 4.6**

**プロパティ 10: 都市情報完全性**
*すべての*都市別天気情報表示において、都市名、天気タイプ、降水確率が明確に区別されて表示される
**検証対象: 要件 4.7**

**プロパティ 11: UI状態同期**
*すべての*天気情報更新において、UIはリアルタイムで最新の状態を反映する
**検証対象: 要件 4.3**

**プロパティ 12: セッション管理**
*すべての*ログアウト操作において、セッションが終了され、ユーザーは認証画面にリダイレクトされる
**検証対象: 要件 4.4**

**プロパティ 13: ヘルスチェック応答**
*すべての*ヘルスチェック要求において、システムは適切な健全性ステータスを返す
**検証対象: 要件 5.3**

**プロパティ 14: データベース障害処理**
*すべての*データベース接続失敗において、システムは適切なフォールバック処理を実行する
**検証対象: 要件 5.4**

## エラーハンドリング

### エラー分類

1. **認証エラー**
   - 無効なトークン
   - 期限切れセッション
   - 未認証アクセス

2. **データエラー**
   - DynamoDB接続失敗
   - データ形式エラー
   - データ生成失敗

3. **APIエラー**
   - 無効なリクエスト
   - レート制限超過
   - サーバー内部エラー

### エラーレスポンス形式

```json
{
  "error": {
    "code": "string",
    "message": "string (日本語)",
    "timestamp": "string (ISO 8601)",
    "request_id": "string"
  }
}
```

### ログ戦略

- **CloudWatch Logs**: Lambda関数のログ
- **X-Ray**: 分散トレーシング
- **CloudWatch Metrics**: パフォーマンスメトリクス

## テスト戦略

### デュアルテストアプローチ

システムの正確性を保証するため、単体テストとプロパティベーステストの両方を実装します：

**単体テスト:**
- 特定の例とエッジケースの検証
- コンポーネント間の統合ポイントのテスト
- エラー条件の具体的なテスト

**プロパティベーステスト:**
- すべての入力に対して成り立つべき普遍的プロパティの検証
- ランダムな入力データでの大量テスト実行
- 設計文書の正確性プロパティの実装

### テスト実装要件

- **プロパティベーステストライブラリ**: Python用のHypothesisを使用
- **最小実行回数**: 各プロパティテストは最低100回実行
- **テストタグ**: 各プロパティベーステストに設計文書のプロパティ番号を明記
- **タグ形式**: `**Feature: serverless-weather-system, Property {number}: {property_text}**`

### テスト環境

- **ローカル開発**: SAM Local + DynamoDB Local
- **統合テスト**: AWS テスト環境
- **E2Eテスト**: Cypress を使用したフロントエンド自動テスト

### テストデータ管理

- **テストデータ生成**: Hypothesisによるランダムデータ生成
- **テスト環境分離**: 本番データとの完全分離
- **クリーンアップ**: テスト後の自動データクリーンアップ